package bs.pi.gateway.client.http;

import java.io.IOException;
import java.net.URI;
import java.util.HashMap;
import java.util.List;

import net.sf.json.JSONObject;

import org.apache.http.Consts;
import org.apache.http.NameValuePair;
import org.apache.http.annotation.NotThreadSafe;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.util.EntityUtils;

import bs.pi.gateway.client.http.HttpMsgSender.HttpDeleteWithBody;
import bs.pi.gateway.main.AppMsg;
import bs.pi.gateway.main.IConverter;
import bs.pi.gateway.main.ISender;

public class HttpSender implements ISender {

	public final String NAME = "HttpSender";
	private IConverter converter;
	private HttpClientCfg cfg;
	
	public HttpSender(HttpClientCfg cfg, IConverter converter){
		this.cfg = cfg;
		this.converter = converter;
	}
	
	@Override
	public String getName() {
		return NAME;
	}

	@Override
	public HashMap<String, Object> send(HashMap<String, Object> msg) {
		if(msg == null)
			return null;
		HashMap<String, Object> msg1 = converter.convertMsgSend(msg);
		if(msg1 == null)
			return null;
		
		if(AppMsg.CMD_UPLOAD_DATA_TO_HTTP_SERVER.equals(msg1.get(AppMsg.KEY_CMD))){
			int sensorID = (int) msg1.get(AppMsg.KEY_SENSOR_ID);
			float sensorValue = (float) msg1.get(AppMsg.KEY_SENSOR_VALUE);
			String url = cfg.getServiceUrl()+"/device/"+cfg.getDeviceID()+"/sensor/"+sensorID+"/datapoint";

			params.put("value",value);
			jo.put(HttpMsgSender.KEY_PARAMS, params);
			JSONObject response = sender.send(jo);
		}
		return null;
	}
	
	
	private HashMap<String, Object> doGet(String url, List<NameValuePair> params) throws IOException{

		String paramStr = "";
		if(params != null && params.size() != 0){
			paramStr = EntityUtils.toString(new UrlEncodedFormEntity(params, Consts.UTF_8));
		}
		HttpGet httpGet = new HttpGet(url+"?"+paramStr);
		httpGet.addHeader("APIKEY", cfg.getApiKey());
	}
	
	private JSONObject doPost() throws IOException{
		if( ! method.equals(METHOD_POST))
			return null;
		
		HttpPost httpPost = new HttpPost(url);
		httpPost.addHeader("APIKEY", apiKey);
		if(params != null && params.size() != 0){
			httpPost.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
		}
		
		return execute(httpPost);
	}

	private JSONObject doPut() throws IOException{
		if( ! method.equals(METHOD_PUT))
			return null;
		
		HttpPut httpPut = new HttpPut(url);
		httpPut.addHeader("APIKEY", apiKey);
		if(params != null && params.size() != 0){
			httpPut.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
		}
		
		return execute(httpPut);
	}
	
	private JSONObject doDelete() throws IOException{
		if( ! method.equals(METHOD_DELETE))
			return null;
		
		HttpDeleteWithBody httpDelete = new HttpDeleteWithBody(url);
		httpDelete.addHeader("APIKEY", apiKey);
		if(params != null && params.size() != 0){
			httpDelete.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
		}
		
		return execute(httpDelete);
	}
	
	@NotThreadSafe
	public class HttpDeleteWithBody extends HttpEntityEnclosingRequestBase {
	    public static final String METHOD_NAME = "DELETE";
	    public String getMethod() { return METHOD_NAME; }
	    public HttpDeleteWithBody(final String uri) {
	        super();
	        setURI(URI.create(uri));
	    }
	    public HttpDeleteWithBody(final URI uri) {
	        super();
	        setURI(uri);
	    }
	    public HttpDeleteWithBody() { super(); }
	}

}
