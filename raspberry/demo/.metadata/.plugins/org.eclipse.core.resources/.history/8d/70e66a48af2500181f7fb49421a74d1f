package bs.pi.gateway.client.zigbee;

import bs.pi.gateway.main.IConverter;
import bs.pi.gateway.main.ISender;
import bs.pi.gateway.msg.IMsg;
import bs.pi.gateway.msg.PortSendResponseMsg;
import bs.pi.gateway.msg.SendPortMsgMsg;
import bs.pi.gateway.msg.ZigbeeSendReponseMsg;

public class ZigbeeSender implements ISender {

	private ZigbeeClientCfg cfg;
	private ISender portSender;
	private IConverter converter;
	
	//搜寻其他zigbee模块网络地址
	private Thread searchNWKAddrThread = new Thread(new Runnable() {
		@Override
		public void run() {
			SendPortMsgMsg portSendMsg1 = new SendPortMsgMsg();
			portSendMsg1.setData(CodeGenerator.networkAddrReuqest(cfg.getOtherZigbeeIEEEAddr1()));
			portSender.send(portSendMsg1);
			
			try {
				Thread.sleep(300);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			SendPortMsgMsg portSendMsg2 = new SendPortMsgMsg();
			portSendMsg1.setData(CodeGenerator.networkAddrReuqest(cfg.getOtherZigbeeIEEEAddr1()));
			portSender.send(portSendMsg2);
			
			try {
				Thread.sleep(300);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	});
	
	public ZigbeeSender(ISender portSender, IConverter converter, ZigbeeClientCfg cfg){
		this.portSender = portSender;
		this.converter = converter;
		this.cfg = cfg;
	}
	
	@Override
	public String getName() {
		return ISender.V_SEND_NAME_ZIGBEE_SNEDER;
	}

	@Override
	public IMsg send(IMsg msg) {
		Object obj = converter.convertMsgSend(msg);
		ZigbeeSendReponseMsg zigbeeSendReponseMsg = new ZigbeeSendReponseMsg();
		if(obj != null){
			ZigbeeMsgSend zigbeeMsgSend = (ZigbeeMsgSend)obj;
			SendPortMsgMsg portSendMsg = new SendPortMsgMsg();
			portSendMsg.setData(CodeGenerator.packetSend(zigbeeMsgSend));
			PortSendResponseMsg portSendResponseMsg = (PortSendResponseMsg) portSender.send(portSendMsg);
			//发送成功
			zigbeeSendReponseMsg.setSendSuccess(portSendResponseMsg.getSendSuccess());
		}else{
			zigbeeSendReponseMsg.setSendSuccess(false);
		}
		return zigbeeSendReponseMsg;
	}

	@Override
	public void init() {
		searchNWKAddrThread.start();
	}

}
