package bs.pi.gateway.client.http;

import java.io.IOException;
import java.net.URI;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import net.sf.json.JSONObject;

import org.apache.http.Consts;
import org.apache.http.NameValuePair;
import org.apache.http.ParseException;
import org.apache.http.annotation.NotThreadSafe;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;

import bs.pi.gateway.main.AppMsg;
import bs.pi.gateway.main.IConverter;
import bs.pi.gateway.main.ISender;

public class HttpSender implements ISender {

	public final static String NAME = "HttpSender";
	
	private IConverter converter;
	private HttpClientCfg cfg;
	private String url;
	private String apiKey;
	private UrlEncodedFormEntity params;
	
	public HttpSender(HttpClientCfg cfg, IConverter converter){
		this.cfg = cfg;
		this.converter = converter;
	}
	
	@Override
	public String getName() {
		return NAME;
	}

	@Override
	public HashMap<String, Object> send(HashMap<String, Object> msg) throws Exception {
		if(msg == null)
			return null;
		HashMap<String, Object> msg1 = converter.convertMsgSend(msg);
		if(msg1 == null)
			return null;
		
		 
		url = (String) msg1.get(HttpConverter.K_HTTP_URL);
		apiKey = (String) msg1.get(HttpConverter.K_HTTP_APIKEY);
		params = (UrlEncodedFormEntity) msg1.get(HttpConverter.K_HTTP_PARAMS);
		String method = "";
		if(HttpConverter.VALUE_HTTP_METHOD_GET.equals(msg1.get(HttpConverter.K_HTTP_METHOD))){
			method = HttpExecuter.METHOD_GET;
		}else if(HttpConverter.VALUE_HTTP_METHOD_POST.equals(msg1.get(HttpConverter.K_HTTP_METHOD))){
			method = HttpExecuter.METHOD_POST;
		}else if(HttpConverter.VALUE_HTTP_METHOD_PUT.equals(msg1.get(HttpConverter.K_HTTP_METHOD))){
			method = HttpExecuter.METHOD_PUT;
		}else if(HttpConverter.VALUE_HTTP_METHOD_DELETE.equals(msg1.get(HttpConverter.K_HTTP_METHOD))){
			method = HttpExecuter.METHOD_DELETE;
		}else{
			return null;
		}
		
		HttpExecuter executer = new HttpExecuter(url, method, apiKey, params);
		return executer.execute();
	}
}
