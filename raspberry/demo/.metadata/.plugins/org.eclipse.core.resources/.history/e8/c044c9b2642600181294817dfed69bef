package bs.pi.gateway.client.zigbee;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;

import com.test.Debugger;

import bs.pi.gateway.client.port.PortClient;
import bs.pi.gateway.main.IClient;
import bs.pi.gateway.main.IConverter;
import bs.pi.gateway.main.IReceivedListener;
import bs.pi.gateway.main.IReceiver;
import bs.pi.gateway.main.ISender;
import bs.pi.gateway.msg.IMsg;
import bs.pi.gateway.msg.PortMsgReceivedMsg;
import bs.pi.gateway.msg.PortSendResponseMsg;
import bs.pi.gateway.msg.SendPortMsgMsg;

public class ZigbeeClient implements IClient{

	public static final String DEFAULT_CFG_PATH = System.getProperty("user.dir")+System.getProperty("file.separator")+"zigbeeClientCfg.properties";
	private String cfgPath;
	private ZigbeeClientCfg cfg;
	private PortClient portClient;
	private ISender portSender;
	private ZigbeeSender zigbeeSender;
	private ZigbeeReceiver zigbeeReceiver;
	private IConverter converter;
	//监听器，用于捕捉硬件地址对应的网络地址
	private IReceivedListener receivedListener = new IReceivedListener() {
		@Override
		public void handleEvent(IMsg msg) {
			if(msg ==null)
				return;
			if(cfg.getZigbeeInfoList() == null || cfg.getZigbeeInfoList().isEmpty())
				return;
			
			ZigbeeMsgReceive zigbeeMsgReceive = null;
			try{
				zigbeeMsgReceive = (ZigbeeMsgReceive)msg;
			}catch(Exception e){
				return;
			}
			
			PortMsgReceivedMsg msg1 = zigbeeMsgReceive.getMsg();
			
			byte cmd0 = msg1.getCmd0();
			byte cmd1 = msg1.getCmd1();
			byte[] data = msg1.getData();
			
			//如果当前zigbee作协调器，有其他节点连接到协调器的时候会收到这条信息，包含了其他zigbee的硬件地址和网络地址
			if(cmd0 == (byte)0x45 && cmd1 == (byte)0xC1){
				byte[] IEEEAddr = new byte[8];
				System.arraycopy(data, 4, IEEEAddr, 0, 8);
				byte[] NWKAddr = new byte[2];
				NWKAddr[0] = data[2];
				NWKAddr[1] = data[3];
				
				ArrayList<ZigbeeInfo> zigbeeInfoList =  cfg.getZigbeeInfoList();
				for(ZigbeeInfo info : zigbeeInfoList){
					if(Arrays.equals(IEEEAddr, info.getIEEEAddr())){
						info.setNWKAddr(NWKAddr);
					}
				}
			}
		}
	};
	
	public ZigbeeClient(String cfgPath, PortClient portClient){
		this.cfgPath = cfgPath;
		this.portClient = portClient;
	}
	
	@Override
	public void init() throws Exception {
		
		if(cfgPath == null)
			cfgPath = DEFAULT_CFG_PATH;
		cfg = new ZigbeeClientCfg(cfgPath);

		portClient.init();
		portClient.start();
		portSender = portClient.getSender();
		
		portSend(CodeGenerator.CMD_DEVICE_RESET);
		Thread.sleep(2000);
		portSend(CodeGenerator.CMD_STARTUP_WITHOUT_LAST_STATE);
		Thread.sleep(500);
		portSend(CodeGenerator.CMD_DEVICE_RESET);
		Thread.sleep(2000);
		portSend(CodeGenerator.chanlistCfg(cfg.getChannel()));
		Thread.sleep(500);
		portSend(CodeGenerator.PANIDCfg(cfg.getPanID()));
		Thread.sleep(500);
		portSend(CodeGenerator.deviceTypeCfg(cfg.getDeviceType()));
		Thread.sleep(500);
		portSend(CodeGenerator.CMD_ZDO_DIRECT_CB);
		Thread.sleep(500);
		portSend(CodeGenerator.appRegister(cfg.getAppReg()));
		Thread.sleep(500);
	}
	
	private PortSendResponseMsg portSend(byte[] data) throws Exception{
		SendPortMsgMsg portSendMsg = new SendPortMsgMsg();
		portSendMsg.setData(data);
		return (PortSendResponseMsg) portSender.send(portSendMsg);
	}

	@Override
	public void start() throws Exception {
		portSend(CodeGenerator.CMD_STARTUP_FROM_APP);
		Thread.sleep(2000);
		
		zigbeeReceiver = new ZigbeeReceiver(portClient.getReceiver(), converter);
		zigbeeReceiver.addReceivedListenr(receivedListener);
		zigbeeReceiver.start();
		
		zigbeeSender = new ZigbeeSender(portSender, converter, cfg);
	}

	@Override
	public void destroy() {
		portClient.destroy();
		zigbeeSender = null;
		zigbeeReceiver = null;
	}

	@Override
	public ISender getSender() {
		return zigbeeSender;
	}

	@Override
	public IReceiver getReceiver() {
		return zigbeeReceiver;
	}

	@Override
	public void setConverter(IConverter converter) {
		this.converter = converter;
	}
	
	public ZigbeeClientCfg getZigbeeClientCfg(){
		return cfg;
	}
}
